name: Build & Release APK

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create the release
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get Version from Tag
        id: get_version
        # This removes the 'v' prefix from the tag name (e.g., v1.0.2 -> 1.0.2)
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        # We override the pubspec version using --build-name and --build-number
        # build-number uses the unique GitHub run number to ensure it always increases
        run: |
          flutter build apk --debug \
            --build-name=${{ steps.get_version.outputs.VERSION }} \
            --build-number=${{ github.run_number }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          files: build/app/outputs/flutter-apk/app-debug.apk
          generate_release_notes: true # This is the "lazy dev" special
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 5
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}